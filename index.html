<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#061425" />
  <title>Stats • ADN66</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./icon-192.png" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <link rel="stylesheet" href="./style.css" />

  <!-- Base visuelle conservée + ajustements couleurs (Roue = rouge) -->
  <style>
    :root{
      --bg0:#040a14;
      --bg1:#061425;
      --card:rgba(255,255,255,.035);
      --line:rgba(234,242,255,.12);
      --ink:#eaf2ff;
      --muted:rgba(234,242,255,.70);
      --r:16px;

      --blueA: rgba(0,170,255,.90);
      --blueB: rgba(0,110,255,.85);

      --yellowA: rgba(255,210,0,.92);
      --yellowB: rgba(255,150,0,.85);

      --violetA: rgba(175,120,255,.85);
      --violetB: rgba(120,90,255,.78);

      --redA: rgba(255,70,70,.88);
      --redB: rgba(255,20,90,.78);

      --shadow: 0 12px 45px rgba(0,0,0,.42);
    }

    html,body{ background: var(--bg0) !important; color: var(--ink) !important; }
    .bg{
      background:
        radial-gradient(1100px 430px at 10% 0%, rgba(0,170,255,.10), transparent 55%),
        radial-gradient(900px 380px at 90% 10%, rgba(255,210,0,.06), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1)) !important;
    }

    .h1{ font-size: 18px !important; font-weight: 900 !important; letter-spacing:.5px; text-transform: uppercase; }
    .sub{ font-size: 12px !important; font-weight: 650; color: var(--muted) !important; }

    .card, .block{
      border-radius: var(--r) !important;
      border: 1px solid var(--line) !important;
      background: var(--card) !important;
      box-shadow: var(--shadow);
    }

    .sectionTitle{
      display:flex; align-items:baseline; justify-content:space-between;
      gap:12px; margin: 14px 0 8px; padding: 0 2px;
    }
    .sectionTitle .t{
      font-weight: 950; letter-spacing:.6px; text-transform: uppercase;
      font-size: 12px; color: rgba(234,242,255,.90);
    }
    .sectionTitle .k{
      font-weight: 800; font-size: 12px; color: rgba(234,242,255,.55); white-space: nowrap;
    }

    .block{ overflow:hidden; }
    .blockHead{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .blockTitle{
      font-weight: 950; letter-spacing:.6px; text-transform: uppercase;
      font-size: 12px; display:flex; align-items:center; gap:10px;
      color: rgba(234,242,255,.92);
    }
    .blockSub{ margin-top: 4px; font-size: 12px; color: rgba(234,242,255,.60); font-weight: 700; }
    .badgeDot{
      width:10px; height:10px; border-radius:999px;
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      flex: 0 0 auto;
    }
    .blockBody{ padding: 12px; }

    .btn{
      border:0; border-radius: 14px; padding: 10px 12px;
      font-weight: 900; letter-spacing:.2px;
      color: rgba(4,10,20,.95);
      background: linear-gradient(135deg, rgba(0,170,255,.95), rgba(0,110,255,.85));
      box-shadow: 0 14px 28px rgba(0,0,0,.22), 0 0 0 1px rgba(255,255,255,.05);
      cursor:pointer;
    }
    .btn.ghost{
      color: rgba(234,242,255,.92);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(234,242,255,.14);
    }

    .twoCols{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 980px){ .twoCols{ grid-template-columns: 1fr; } }

    .miniViz{ display:flex; flex-direction:column; gap: 8px; margin-top: 10px; }
    .miniRow{
      display:grid; grid-template-columns: 1fr; gap: 6px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      overflow: hidden;
    }
    .miniTop{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px; font-weight: 900; min-width: 0;
    }
    .miniTop .lbl{
      color: rgba(234,242,255,.92);
      overflow:hidden; text-overflow: ellipsis; white-space: nowrap;
      max-width: 62%; min-width: 0; font-size: 13px;
    }
    .miniTop .val{
      color: rgba(234,242,255,.78);
      font-weight: 950; white-space: nowrap; font-size: 13px; flex: 0 0 auto;
    }
    .miniTop .pct{ font-weight: 950; color: rgba(234,242,255,.86); margin-left: 8px; font-size: 12px; }
    .miniTrack{
      height: 10px; border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden; border: 1px solid rgba(255,255,255,.10);
    }
    .miniFill{ height:100%; width:0%; max-width: 100%; border-radius:999px; transition: width .25s ease; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; color: rgba(234,242,255,.82); line-height: 1.35; }
    .mono b{ color: rgba(234,242,255,.95); }
    .mono a{ color: rgba(234,242,255,.92); text-decoration: none; border-bottom: 1px dotted rgba(234,242,255,.35); }
    .mono a:hover{ border-bottom-color: rgba(234,242,255,.65); }

    /* palettes */
    .t-nuit .badgeDot{ background: var(--blueA); }
    .t-catalan .badgeDot{ background: var(--yellowA); }
    .t-hibair .badgeDot{ background: var(--violetA); }
    .t-wheel .badgeDot{ background: var(--redA); }

    .t-nuit .miniFill{ background: linear-gradient(90deg, var(--blueA), var(--blueB)); }
    .t-catalan .miniFill{ background: linear-gradient(90deg, var(--yellowA), var(--yellowB)); }
    .t-hibair .miniFill{ background: linear-gradient(90deg, var(--violetA), var(--violetB)); }
    .t-wheel .miniFill{ background: linear-gradient(90deg, var(--redA), var(--redB)); }

    .tableWrap{ overflow:auto; }
    table{ width:100%; border-collapse: collapse; }
    th,td{ padding: 10px 10px; border-bottom: 1px solid rgba(255,255,255,.07); font-size: 13px; }
    th{ text-transform: uppercase; letter-spacing: .35px; color: rgba(234,242,255,.55); text-align:left; }
    td{ color: rgba(234,242,255,.92); }
    .right{ text-align:right; }
    .hideSm{ display: table-cell; }
    @media (max-width: 700px){ .hideSm{ display:none; } }
  </style>
</head>

<body>
  <div class="bg"></div>

  <div class="top">
    <div class="brand">
      <img class="logo" src="./icon-192.png" alt="Logo" />
      <div>
        <div class="h1">Stats</div>
        <div class="sub">Suivi tracking • ADN66</div>
      </div>
    </div>

    <div class="pills">
      <div class="pill"><span class="dot"></span>Cloudflare</div>
      <div class="pill">D1 • <span id="dbName">stats_db</span></div>
      <div class="pill">API • <span id="apiHost">stats.aperos.net</span></div>
    </div>

    <div class="actions">
      <button class="btn" id="btnRefresh">Actualiser</button>
      <button class="btn ghost" id="btnCopyLinks">Copier mes liens</button>
      <button class="btn ghost" id="btnInstall" hidden>Installer</button>
    </div>

    <div class="statusRow">
      <div id="status" class="status warn">—</div>
      <div class="mini">
        <span>Auto</span>
        <label class="switch">
          <input type="checkbox" id="autoToggle" />
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- 1) Liens (exact format demandé) -->
    <div class="sectionTitle">
      <div class="t">Liens tracking</div>
      <div class="k">copie/colle</div>
    </div>

    <div class="block">
      <div class="blockHead">
        <div>
          <div class="blockTitle"><span class="badgeDot" style="background:rgba(255,255,255,.35)"></span> Mes URLs</div>
          <div class="blockSub">Format ADN66 (Apéro / Catalan / Hibair / Roue)</div>
        </div>
        <span class="chip">trak.txt</span>
      </div>
      <div class="blockBody">
        <div class="mono" id="linksBox">—</div>
      </div>
    </div>

    <!-- 2) Graphique barres (4 projets + couleurs) -->
    <div class="sectionTitle">
      <div class="t">Barres</div>
      <div class="k">apero / catalan / hibair / roue</div>
    </div>

    <div class="block">
      <div class="blockHead">
        <div>
          <div class="blockTitle"><span class="badgeDot" style="background:rgba(255,255,255,.35)"></span> Totaux par projet</div>
          <div class="blockSub">1 barre = 1 univers</div>
        </div>
        <span class="chip">mix clicks + events</span>
      </div>
      <div class="blockBody">
        <div class="twoCols">
          <div class="miniViz t-nuit" id="vizProjectNuit"></div>
          <div class="miniViz t-catalan" id="vizProjectCatalan"></div>
        </div>
        <div class="twoCols" style="margin-top:10px;">
          <div class="miniViz t-hibair" id="vizProjectHibair"></div>
          <div class="miniViz t-wheel" id="vizProjectWheel"></div>
        </div>
      </div>
    </div>

    <!-- 3) OS + Navigateur + Appareil -->
    <div class="sectionTitle">
      <div class="t">Système</div>
      <div class="k">Android / iOS / Chrome / Safari…</div>
    </div>

    <div class="block">
      <div class="blockHead">
        <div>
          <div class="blockTitle"><span class="badgeDot" style="background:rgba(255,255,255,.35)"></span> Mobile / OS / Navigateur</div>
          <div class="blockSub">données issues de /api/stats</div>
        </div>
        <span class="chip">byDevice/byOS/byBrowser</span>
      </div>
      <div class="blockBody">
        <div class="twoCols">
          <div>
            <div class="blockSub">Appareil</div>
            <div class="miniViz" id="vizDevice"></div>
            <div class="tableWrap" style="margin-top:8px;">
              <table>
                <thead><tr><th>Appareil</th><th class="right">N</th></tr></thead>
                <tbody id="tbodyDevice"></tbody>
              </table>
            </div>
          </div>
          <div>
            <div class="blockSub">OS</div>
            <div class="miniViz" id="vizOS"></div>
            <div class="tableWrap" style="margin-top:8px;">
              <table>
                <thead><tr><th>OS</th><th class="right">N</th></tr></thead>
                <tbody id="tbodyOS"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <div class="blockSub">Navigateur</div>
          <div class="miniViz" id="vizBrowser"></div>
          <div class="tableWrap" style="margin-top:8px;">
            <table>
              <thead><tr><th>Navigateur</th><th class="right">N</th></tr></thead>
              <tbody id="tbodyBrowser"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 4) 50 derniers -->
    <div class="sectionTitle">
      <div class="t">Derniers</div>
      <div class="k">50 derniers (clicks + events)</div>
    </div>

    <div class="block">
      <div class="blockHead">
        <div>
          <div class="blockTitle"><span class="badgeDot" style="background:rgba(255,255,255,.35)"></span> Logs</div>
          <div class="blockSub">OS + Navigateur + Source</div>
        </div>
        <span class="chip">last</span>
      </div>
      <div class="blockBody">
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Nom</th>
                <th class="hideSm">Src</th>
                <th class="hideSm">OS</th>
                <th class="hideSm">Nav</th>
              </tr>
            </thead>
            <tbody id="tbodyLast50"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="foot" style="text-align:center; padding:16px 0; color: rgba(234,242,255,.55); font-size: 12px;">
      <button class="btn ghost" id="btnHardReload">Forcer MAJ</button>
    </div>

    <!-- tables invisibles (remplies par app.js) -->
    <div style="display:none">
      <table><tbody id="tbodyCountry"></tbody></table>
    </div>
  </div>

  <script src="./app.js"></script>

  <!-- UI helper pour miniViz + rendu des sections -->
  <script>
    (function(){
      const $ = (id) => document.getElementById(id);

      function toInt(txt){
        if(!txt) return 0;
        const n = String(txt).replace(/[^\d]/g,'');
        return n ? parseInt(n,10) : 0;
      }
      function fmt(n){
        const v = Number(n);
        if(!Number.isFinite(v)) return "—";
        return new Intl.NumberFormat("fr-FR").format(v);
      }

      function normLabelFR(s){
        const x = String(s || "").trim();
        const map = {
          "desktop": "Ordinateur",
          "mobile": "Téléphone",
          "Android": "Android",
          "iOS": "iOS",
          "Windows": "Windows",
          "macOS": "macOS",
          "Chrome": "Chrome",
          "Safari": "Safari",
          "Edge": "Edge",
          "Firefox": "Firefox"
        };
        return map[x] || x;
      }

      function renderMiniViz(containerId, items, themeClass, opts={}){
        const container = $(containerId);
        if(!container) return;
        container.className = "miniViz " + (themeClass || "");

        if(!items || !items.length){
          container.innerHTML = "";
          return;
        }

        const maxItems = opts.maxItems ?? 6;
        const sorted = items.slice().sort((a,b)=>b.value-a.value);
        const total = sorted.reduce((s,x)=>s+x.value,0) || 0;

        const top = sorted.slice(0, maxItems);
        const rest = sorted.slice(maxItems);
        const otherSum = rest.reduce((s,x)=>s+x.value,0);
        if(otherSum > 0) top.push({label:"Autres", value: otherSum});

        const maxV = Math.max(...top.map(x=>x.value), 1);

        container.innerHTML = top.map(x=>{
          const pct = total ? (x.value/total*100) : 0;
          const w = Math.max(0, Math.min(100, maxV ? (x.value/maxV*100) : 0));
          return `
            <div class="miniRow">
              <div class="miniTop">
                <div class="lbl" title="${x.label}">${x.label}</div>
                <div class="val">${fmt(x.value)} <span class="pct">• ${pct.toFixed(0)}%</span></div>
              </div>
              <div class="miniTrack"><div class="miniFill" style="width:${w.toFixed(2)}%"></div></div>
            </div>
          `;
        }).join("");
      }

      function parseSimpleTbody(tbodyId){
        const tb = $(tbodyId);
        if(!tb) return [];
        const rows = Array.from(tb.querySelectorAll("tr"));
        const out = [];
        for(const tr of rows){
          const tds = tr.querySelectorAll("td,th");
          if(!tds || tds.length < 2) continue;
          const label = normLabelFR((tds[0].textContent || "").trim());
          const value = toInt((tds[1].textContent || "").trim());
          if(label) out.push({label, value});
        }
        return out;
      }

      function sum(items){ return (items||[]).reduce((s,x)=>s+(x.value||0),0); }

      function updateMini(){
        renderMiniViz("vizDevice", parseSimpleTbody("tbodyDevice"), "");
        renderMiniViz("vizOS", parseSimpleTbody("tbodyOS"), "");
        renderMiniViz("vizBrowser", parseSimpleTbody("tbodyBrowser"), "");

        // Projects (values are written as data-attrs by app.js)
        const p = window.__ADN66_PROJECTS__ || null;
        if(p){
          renderMiniViz("vizProjectNuit",    [{label:"Apéro de Nuit", value:p.nuit||0}], "t-nuit", {maxItems: 2});
          renderMiniViz("vizProjectCatalan", [{label:"Apéro Catalan", value:p.catalan||0}], "t-catalan", {maxItems: 2});
          renderMiniViz("vizProjectHibair",  [{label:"Hibair Drink", value:p.hibair||0}], "t-hibair", {maxItems: 2});
          renderMiniViz("vizProjectWheel",   [{label:"Roue", value:p.wheel||0}], "t-wheel", {maxItems: 2});
        }
      }

      function boot(){
        updateMini();
        const ids = ["tbodyDevice","tbodyOS","tbodyBrowser","tbodyLast50"];
        const obs = new MutationObserver(() => updateMini());
        ids.forEach(id=>{
          const el = $(id);
          if(el) obs.observe(el, {childList:true, subtree:true, characterData:true});
        });

        const btn = $("btnRefresh");
        if(btn) btn.addEventListener("click", () => setTimeout(updateMini, 350));
      }

      if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot);
      else boot();
    })();
  </script>
</body>
</html>
