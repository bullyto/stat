<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#061425" />
  <title>Stats • Apéro de Nuit 66</title>
  <meta name="description" content="Dashboard marketing • suivi des clics" />

  <!-- Social share -->
  <meta property="og:title" content="Stats • Apéro de Nuit 66" />
  <meta property="og:description" content="Dashboard marketing • suivi des clics" />
  <meta property="og:image" content="./assets/share-1200x630.png" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./assets/icon-192.png" />
  <link rel="apple-touch-icon" href="./assets/icon-192.png" />

  <link rel="stylesheet" href="./style.css" />

  <!-- ✅ Styles UI (sans toucher style.css) -->
  <style>
    :root{
      --brand0:#040a14;
      --brand1:#061425;
      --brand2:#0a2342;

      --ink:#eaf2ff;
      --muted:rgba(234,242,255,.72);
      --soft:rgba(234,242,255,.10);
      --line:rgba(234,242,255,.14);
      --glow:0 18px 60px rgba(0,0,0,.45);
      --r:18px;

      /* Bleu (Apéro de Nuit) */
      --blueA: rgba(0,170,255,.92);
      --blueB: rgba(0,120,255,.88);

      /* Jaune (Apéro Catalan) */
      --yellowA: rgba(255,208,0,.95);
      --yellowB: rgba(255,153,0,.92);

      /* Violet (Hibair) */
      --violetA: rgba(170,120,255,.92);
      --violetB: rgba(130,90,255,.88);

      /* Vert (Roue) */
      --greenA: rgba(0,255,170,.85);
      --greenB: rgba(0,190,120,.82);

      /* Accents généraux */
      --accentA: var(--blueA);
      --accentB: var(--blueB);
    }

    html,body{
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      letter-spacing:.2px;
      background: var(--brand0) !important;
      color: var(--ink) !important;
    }

    .bg{
      background:
        radial-gradient(1200px 460px at 10% 0%, rgba(0,170,255,.14), transparent 55%),
        radial-gradient(900px 420px at 90% 10%, rgba(0,120,255,.12), transparent 55%),
        radial-gradient(800px 420px at 40% 100%, rgba(0,255,210,.08), transparent 60%),
        linear-gradient(180deg, var(--brand0), var(--brand1)) !important;
    }

    .h1{
      letter-spacing:.6px;
      text-transform: uppercase;
      font-weight: 800;
    }
    .sub{
      color: var(--muted);
      font-weight: 600;
    }

    .top{ backdrop-filter: blur(8px); }
    .brand .logo{
      border-radius: 16px;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
    }

    /* KPI : chiffres plus petits + identiques */
    .kpiValue{
      font-size: 28px !important;
      line-height: 1.05 !important;
      font-weight: 950 !important;
      letter-spacing: .2px !important;
      white-space: nowrap !important;
    }
    @media (max-width: 520px){
      .kpiValue{ font-size: 24px !important; }
    }

    .card.hero{
      position: relative;
      overflow: hidden;
      border: 1px solid var(--line);
      box-shadow: var(--glow);
    }
    .card.hero::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(1200px 380px at 10% 0%, rgba(0,170,255,.18), transparent 55%),
        radial-gradient(900px 320px at 90% 10%, rgba(0,120,255,.16), transparent 52%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      pointer-events:none;
    }
    .heroTitle{
      letter-spacing: .8px;
      font-weight: 900;
      text-transform: uppercase;
    }
    .heroText{
      color: var(--muted);
      font-weight: 650;
    }

    .btn{ border-color: rgba(234,242,255,.16) !important; }
    .btn:not(.ghost){
      background: linear-gradient(180deg, rgba(0,170,255,.18), rgba(0,120,255,.12)) !important;
    }

    /* Sections */
    .sectionTitle{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      margin: 10px 0 8px;
      padding: 0 2px;
    }
    .sectionTitle .t{
      font-weight: 900;
      letter-spacing:.6px;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(234,242,255,.88);
    }
    .sectionTitle .k{
      font-weight: 800;
      font-size: 12px;
      color: rgba(234,242,255,.60);
      white-space: nowrap;
    }

    /* Mini-graph universel */
    .miniViz{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      max-width: 100%;
    }
    .miniRow{
      display:grid;
      grid-template-columns: 1fr;
      gap: 6px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .miniTop{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 12px;
      font-weight: 900;
    }
    .miniTop .lbl{
      color: rgba(234,242,255,.92);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 70%;
    }
    .miniTop .val{
      color: rgba(234,242,255,.72);
      font-weight: 950;
      white-space: nowrap;
      display:flex;
      align-items:baseline;
      gap: 8px;
      flex: 0 0 auto;
    }
    .miniTop .pct{
      font-weight: 950;
      color: rgba(234,242,255,.86);
      white-space: nowrap;
    }
    .miniTrack{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
    }
    .miniFill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, var(--accentA), var(--accentB));
      transition: width .35s ease;
      max-width: 100%;
    }

    /* Thèmes */
    .miniFill.t-nuit{ background: linear-gradient(90deg, var(--blueA), var(--blueB)); }
    .miniFill.t-catalan{ background: linear-gradient(90deg, var(--yellowA), var(--yellowB)); }
    .miniFill.t-hibair{ background: linear-gradient(90deg, var(--violetA), var(--violetB)); }
    .miniFill.t-wheel{ background: linear-gradient(90deg, var(--greenA), var(--greenB)); }

    .miniHint{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(234,242,255,.60);
      font-weight: 750;
    }
  </style>
</head>

<body>
  <div class="bg"></div>

  <div class="top">
    <div class="brand">
      <img class="logo" src="./assets/icon-192.png" alt="Logo" />
      <div>
        <div class="h1">Stats</div>
        <div class="sub">Dashboard marketing • suivi des clics</div>
      </div>
    </div>

    <div class="pills">
      <div class="pill"><span class="dot"></span>Cloudflare Workers</div>
      <div class="pill">D1 • <span id="dbName">stats_db</span></div>
      <div class="pill">API • <span id="apiHost">stats.aperos.net</span></div>
    </div>

    <div class="actions">
      <button class="btn" id="btnRefresh">Actualiser</button>
      <button class="btn ghost" id="btnCopyLinks">Copier mes liens</button>
      <button class="btn ghost" id="btnInstall" hidden>Ajouter à l’écran d’accueil</button>
    </div>

    <div class="statusRow">
      <div id="status" class="status warn">—</div>
      <div class="mini">
        <span>Auto</span>
        <label class="switch" title="Auto-refresh 30s">
          <input type="checkbox" id="autoToggle" />
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card hero">
      <div class="heroTitle">APERO DE NUIT 66</div>
      <div class="heroText">
        <b>stat.aperos.net</b> • stats globales + détails
      </div>
    </div>

    <div class="grid">
      <div class="card kpi">
        <div class="kpiLabel">Clics total</div>
        <div class="kpiValue" id="kpiTotal">—</div>
        <div class="kpiHint">Tous canaux confondus</div>
      </div>
      <div class="card kpi">
        <div class="kpiLabel">Aujourd’hui</div>
        <div class="kpiValue" id="kpiToday">—</div>
        <div class="kpiHint">Date locale</div>
      </div>
      <div class="card kpi">
        <div class="kpiLabel">Campagnes suivies</div>
        <div class="kpiValue" id="kpiCampaigns">—</div>
        <div class="kpiHint">apero • catalan • chance • jeux</div>
      </div>
    </div>

    <!-- ✅ EVENTS KPI (si tu as ajouté ces IDs dans ta version) -->
    <div class="grid" style="margin-top:10px">
      <div class="card kpi">
        <div class="kpiLabel">Events total</div>
        <div class="kpiValue" id="kpiEventsTotal">—</div>
        <div class="kpiHint">Actions (call / age / etc.)</div>
      </div>
      <div class="card kpi">
        <div class="kpiLabel">Events aujourd’hui</div>
        <div class="kpiValue" id="kpiEventsToday">—</div>
        <div class="kpiHint">Date locale</div>
      </div>
      <div class="card kpi">
        <div class="kpiLabel">Tracking</div>
        <div class="kpiValue" id="kpiEventsKinds">—</div>
        <div class="kpiHint">events.byEvent</div>
      </div>
    </div>

    <!-- ✅ COMPARATIF (FIX): plus de doublon + % opposé (Nuit vs Catalan) -->
    <div class="sectionTitle" style="margin-top:14px">
      <div class="t">Comparatif</div>
      <div class="k">Nuit vs Catalan</div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Total events (Apéro de Nuit 66 / Apéro Catalan)</div>
          <div class="sub">Une seule vue (barres + valeur + %)</div>
        </div>
        <span class="chip">events.byBrand</span>
      </div>

      <!-- ✅ On garde uniquement le rendu complet -->
      <div id="vizBrandCompare" class="miniViz"></div>
    </div>

    <!-- ✅ DÉTAILS EVENTS -->
    <div class="sectionTitle">
      <div class="t">Détails</div>
      <div class="k">Tech & lecture fine</div>
    </div>

    <div class="grid2">
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Campagnes (table clicks)</div>
            <div class="sub">apero / catalan / chance / jeux</div>
          </div>
          <span class="chip">clicks.byCampaign</span>
        </div>

        <div class="campaignCards">
          <div class="campaignCard">
            <div class="campTop">
              <div class="campName">Apéro</div>
              <span class="campPill">apero</span>
            </div>
            <div class="campValue" id="cApero">—</div>
            <div class="campExact">/go/apero?src=…</div>
          </div>

          <div class="campaignCard">
            <div class="campTop">
              <div class="campName">Catalan</div>
              <span class="campPill">catalan</span>
            </div>
            <div class="campValue" id="cCatalan">—</div>
            <div class="campExact">/go/catalan?src=…</div>
          </div>

          <div class="campaignCard">
            <div class="campTop">
              <div class="campName">Chance</div>
              <span class="campPill">chance</span>
            </div>
            <div class="campValue" id="cChance">—</div>
            <div class="campExact">/go/chance?src=…</div>
          </div>

          <div class="campaignCard">
            <div class="campTop">
              <div class="campName">Jeux</div>
              <span class="campPill">jeux</span>
            </div>
            <div class="campValue" id="cJeux">—</div>
            <div class="campExact">/go/jeux?src=…</div>
          </div>
        </div>

        <div class="tableWrap">
          <table class="table">
            <thead>
              <tr>
                <th>Campagne</th>
                <th class="right">Clics</th>
                <th class="hideSm">Tracking</th>
                <th class="hideSm">Destination</th>
              </tr>
            </thead>
            <tbody id="tbodyCampaign"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Origines (source)</div>
            <div class="sub">direct / facebook / sms / qr…</div>
          </div>
          <span class="chip">bySource</span>
        </div>
        <div class="tableWrap">
          <table class="table small">
            <thead><tr><th>Source</th><th class="right">Clics</th></tr></thead>
            <tbody id="tbodySource"></tbody>
          </table>
        </div>
        <div id="vizSource" class="miniViz"></div>
      </div>

      <!-- ✅ EVENTS: byEvent / byBrand / byChannel / byAction -->
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Events (byEvent)</div>
            <div class="sub">Apéro Nuit / Catalan / Hibair / wheel + actions</div>
          </div>
          <span class="chip">events.byEvent</span>
        </div>

        <div class="tableWrap">
          <table class="table small">
            <thead><tr><th>Event</th><th class="right">Clics</th></tr></thead>
            <tbody id="tbodyEvent"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Events (byBrand)</div>
            <div class="sub">apero_nuit / apero_catalan / hibair / wheel</div>
          </div>
          <span class="chip">events.byBrand</span>
        </div>

        <div class="tableWrap">
          <table class="table small">
            <thead><tr><th>Brand</th><th class="right">Clics</th></tr></thead>
            <tbody id="tbodyBrand"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Events (byChannel)</div>
            <div class="sub">facebook / sms / qr / app / site</div>
          </div>
          <span class="chip">events.byChannel</span>
        </div>

        <div class="tableWrap">
          <table class="table small">
            <thead><tr><th>Canal</th><th class="right">Clics</th></tr></thead>
            <tbody id="tbodyChannel"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Events (byAction)</div>
            <div class="sub">click / call / order / age_accept / age_refuse</div>
          </div>
          <span class="chip">events.byAction</span>
        </div>

        <div class="tableWrap">
          <table class="table small">
            <thead><tr><th>Action</th><th class="right">Clics</th></tr></thead>
            <tbody id="tbodyAction"></tbody>
          </table>
        </div>
      </div>

      <!-- ✅ TECH (pays retiré volontairement) -->
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Appareils</div>
            <div class="sub">mobile / desktop</div>
          </div>
          <span class="chip">Device</span>
        </div>
        <div class="tableWrap">
          <table class="table small">
            <thead><tr><th>Appareil</th><th class="right">Clics</th></tr></thead>
            <tbody id="tbodyDevice"></tbody>
          </table>
        </div>
        <div id="vizDevice" class="miniViz"></div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Systèmes</div>
            <div class="sub">Android / iOS / Windows / macOS…</div>
          </div>
          <span class="chip">OS</span>
        </div>
        <div class="tableWrap">
          <table class="table small">
            <thead><tr><th>OS</th><th class="right">Clics</th></tr></thead>
            <tbody id="tbodyOS"></tbody>
          </table>
        </div>
        <div id="vizOS" class="miniViz"></div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Navigateurs</div>
            <div class="sub">Chrome / Safari / Edge…</div>
          </div>
          <span class="chip">Browser</span>
        </div>
        <div class="tableWrap">
          <table class="table small">
            <thead><tr><th>Navigateur</th><th class="right">Clics</th></tr></thead>
            <tbody id="tbodyBrowser"></tbody>
          </table>
        </div>
        <div id="vizBrowser" class="miniViz"></div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Clics par heure (aujourd’hui)</div>
            <div class="sub">si l’API renvoie hourly</div>
          </div>
          <span class="chip">Heure locale</span>
        </div>
        <div class="tableWrap">
          <table class="table small">
            <thead><tr><th>Heure</th><th class="right">Clics</th></tr></thead>
            <tbody id="tbodyHourly"></tbody>
          </table>
        </div>
        <div id="vizHourly" class="miniViz"></div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Derniers clics</div>
            <div class="sub">les 50 derniers</div>
          </div>
          <span class="chip">last</span>
        </div>
        <div class="tableWrap">
          <table class="table small">
            <thead>
              <tr>
                <th>Date</th>
                <th>Campagne</th>
                <th>Source</th>
                <th class="hideSm">Device</th>
                <th class="hideSm">OS</th>
                <th class="hideSm">Browser</th>
              </tr>
            </thead>
            <tbody id="tbodyLast"></tbody>
          </table>
        </div>
      </div>

      <div class="foot">
        <span id="buildInfo">PWA prête</span>
        <span class="sep">•</span>
        <button class="linkBtn" id="btnHardReload">Forcer MAJ</button>
        <span class="sep">•</span>
        <a href="https://stats.aperos.net/api/health" target="_blank" rel="noopener">Health</a>
        <span class="sep">•</span>
        <a href="https://stats.aperos.net/api/stats" target="_blank" rel="noopener">Stats</a>
      </div>
    </div>
  </div>

  <script src="./app.js"></script>

  <!-- ✅ FIX DIRECT ICI : Comparatif % opposé + pas de doublon -->
  <script>
    (function(){
      const $ = (id) => document.getElementById(id);

      function toInt(txt){
        if(!txt) return 0;
        const n = String(txt).replace(/[^\d]/g,'');
        return n ? parseInt(n,10) : 0;
      }
      function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
      function fmt(n){
        const num = Number(n);
        if(!Number.isFinite(num)) return "—";
        return new Intl.NumberFormat("fr-FR").format(num);
      }

      function parseTableBody(tbodyId){
        const tb = document.getElementById(tbodyId);
        if(!tb) return [];
        const rows = Array.from(tb.querySelectorAll("tr"));
        const out = [];
        for(const tr of rows){
          const tds = tr.querySelectorAll("td,th");
          if(!tds || tds.length < 2) continue;
          const label = (tds[0].textContent || "").trim();
          const value = toInt((tds[1].textContent || "").trim());
          if(label) out.push({label, value});
        }
        return out;
      }

      function renderMiniViz(containerId, items, opts={}){
        const container = document.getElementById(containerId);
        if(!container) return;

        if(!items || !items.length){
          container.innerHTML = `<div class="miniHint">— Pas de données</div>`;
          return;
        }

        const maxItems = opts.maxItems ?? 6;
        const sorted = items.slice().sort((a,b)=>b.value-a.value);
        const total = sorted.reduce((s,x)=>s+x.value,0) || 0;

        const top = sorted.slice(0, maxItems);
        const rest = sorted.slice(maxItems);
        const otherSum = rest.reduce((s,x)=>s+x.value,0);
        if(otherSum > 0) top.push({label:"Autres", value: otherSum});

        const maxV = Math.max(...top.map(x=>x.value), 1);

        container.innerHTML =
          top.map(x=>{
            const pct = total ? (x.value/total*100) : 0;
            const w = maxV ? (x.value/maxV*100) : 0;
            return `
              <div class="miniRow">
                <div class="miniTop">
                  <div class="lbl" title="${x.label}">${x.label}</div>
                  <div class="val">${fmt(x.value)} <span class="pct">• ${pct.toFixed(0)}%</span></div>
                </div>
                <div class="miniTrack"><div class="miniFill" style="width:${w.toFixed(2)}%"></div></div>
              </div>
            `;
          }).join("");
      }

      // ✅ FIX: Comparatif Nuit vs Catalan
      // - PLUS DE DOUBLON (on affiche uniquement les barres)
      // - % calculé sur (nuit + catalan), donc pas 100%/100%
      function updateBrandCompare(){
        const items = parseTableBody("tbodyBrand");
        const nuit = items.find(x => x.label === "apero_nuit")?.value || 0;
        const catalan = items.find(x => x.label === "apero_catalan")?.value || 0;

        const total = nuit + catalan;
        const maxV = Math.max(nuit, catalan, 1);

        const el = $("vizBrandCompare");
        if(!el) return;

        if(total <= 0){
          el.innerHTML = `<div class="miniHint">— Pas de données</div>`;
          return;
        }

        const rows = [
          { label:"Apéro de Nuit 66", value:nuit, cls:"t-nuit" },
          { label:"Apéro Catalan", value:catalan, cls:"t-catalan" }
        ];

        el.innerHTML = rows.map(r=>{
          const pct = total ? (r.value/total*100) : 0;          // ✅ opposé
          const w = maxV ? (r.value/maxV*100) : 0;              // largeur relative
          return `
            <div class="miniRow">
              <div class="miniTop">
                <div class="lbl" title="${r.label}">${r.label}</div>
                <div class="val">${fmt(r.value)} <span class="pct">• ${pct.toFixed(0)}%</span></div>
              </div>
              <div class="miniTrack">
                <div class="miniFill ${r.cls}" style="width:${clamp(w,0,100).toFixed(2)}%"></div>
              </div>
            </div>
          `;
        }).join("");
      }

      function updateAllMiniCharts(){
        renderMiniViz("vizSource",  parseTableBody("tbodySource"));
        renderMiniViz("vizDevice",  parseTableBody("tbodyDevice"));
        renderMiniViz("vizOS",      parseTableBody("tbodyOS"));
        renderMiniViz("vizBrowser", parseTableBody("tbodyBrowser"));
        renderMiniViz("vizHourly",  parseTableBody("tbodyHourly"));
        updateBrandCompare(); // ✅ important
      }

      function boot(){
        updateAllMiniCharts();

        const btn = $("btnRefresh");
        if(btn){
          btn.addEventListener("click", () => {
            setTimeout(updateAllMiniCharts, 450);
          });
        }

        // observe mutations (app.js remplit les tbody)
        const ids = [
          "tbodySource","tbodyDevice","tbodyOS","tbodyBrowser","tbodyHourly",
          "tbodyBrand"
        ];
        const obs = new MutationObserver(() => updateAllMiniCharts());
        ids.forEach(id=>{
          const el = $(id);
          if(el) obs.observe(el, {childList:true, subtree:true, characterData:true});
        });
      }

      if(document.readyState === "loading"){
        document.addEventListener("DOMContentLoaded", boot);
      }else{
        boot();
      }
    })();
  </script>
</body>
</html>
