<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#061425" />
  <title>Stats • Apéro de Nuit 66</title>
  <meta name="description" content="Dashboard marketing • suivi des clics" />

  <!-- Social share -->
  <meta property="og:title" content="Stats • Apéro de Nuit 66" />
  <meta property="og:description" content="Dashboard marketing • suivi des clics" />
  <meta property="og:image" content="./assets/share-1200x630.png" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./icon-192.png" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <link rel="stylesheet" href="./style.css" />

  <style>
    :root{
      --brand0:#040a14;
      --brand1:#061425;
      --brand2:#0a2342;
      --ink:#eaf2ff;
      --muted:rgba(234,242,255,.72);
      --line:rgba(234,242,255,.14);
      --glow:0 18px 60px rgba(0,0,0,.45);
      --r:18px;

      /* accents */
      --blueA: rgba(0,170,255,.92);
      --blueB: rgba(0,120,255,.88);

      --yellowA: rgba(255,210,0,.92);
      --yellowB: rgba(255,160,0,.85);

      --greenA: rgba(0,255,150,.75);
      --greenB: rgba(0,200,120,.70);

      --violetA: rgba(180,120,255,.85);
      --violetB: rgba(120,90,255,.80);
    }

    html,body{
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      letter-spacing:.2px;
      background: var(--brand0) !important;
      color: var(--ink) !important;
    }

    .bg{
      background:
        radial-gradient(1200px 460px at 10% 0%, rgba(0,170,255,.14), transparent 55%),
        radial-gradient(900px 420px at 90% 10%, rgba(0,120,255,.12), transparent 55%),
        radial-gradient(800px 420px at 40% 100%, rgba(0,255,210,.08), transparent 60%),
        linear-gradient(180deg, var(--brand0), var(--brand1)) !important;
    }

    .h1{ letter-spacing:.6px; text-transform: uppercase; font-weight: 800; }
    .sub{ color: var(--muted); font-weight: 600; }
    .top{ backdrop-filter: blur(8px); }
    .brand .logo{ border-radius: 16px; box-shadow: 0 10px 26px rgba(0,0,0,.35); }

    .kpiValue{
      font-size: 28px !important;
      line-height: 1.05 !important;
      font-weight: 950 !important;
      letter-spacing: .2px !important;
      white-space: nowrap !important;
    }
    @media (max-width: 520px){
      .kpiValue{ font-size: 24px !important; }
    }

    .card.hero{
      position: relative;
      overflow: hidden;
      border: 1px solid var(--line);
      box-shadow: var(--glow);
    }
    .card.hero::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(1200px 380px at 10% 0%, rgba(0,170,255,.18), transparent 55%),
        radial-gradient(900px 320px at 90% 10%, rgba(0,120,255,.16), transparent 52%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      pointer-events:none;
    }
    .heroTitle{ letter-spacing:.8px; font-weight:900; text-transform: uppercase; }
    .heroText{ color: var(--muted); font-weight: 650; }
    .mutedNote{
      color: rgba(234,242,255,.60);
      font-weight: 750;
      font-size: 12px;
      line-height: 1.25;
    }

    .btn{ border-color: rgba(234,242,255,.16) !important; }
    .btn:not(.ghost){
      background: linear-gradient(180deg, rgba(0,170,255,.18), rgba(0,120,255,.12)) !important;
    }

    .sectionTitle{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      margin: 12px 0 8px;
      padding: 0 2px;
    }
    .sectionTitle .t{
      font-weight: 900;
      letter-spacing:.6px;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(234,242,255,.88);
    }
    .sectionTitle .k{
      font-weight: 800;
      font-size: 12px;
      color: rgba(234,242,255,.60);
      white-space: nowrap;
    }

    /* --- blocs/encarts --- */
    .block{
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      overflow: hidden;
      box-shadow: var(--glow);
    }
    .blockHead{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .blockTitle{
      font-weight: 950;
      letter-spacing:.6px;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(234,242,255,.92);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badgeDot{
      width:10px; height:10px; border-radius:999px;
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.14);
    }
    .blockSub{ color: rgba(234,242,255,.70); font-weight: 750; font-size: 12px; margin-top: 4px; }

    .blockBody{ padding: 14px; }

    .twoCols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .twoCols{ grid-template-columns: 1fr; }
    }

    .miniViz{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 10px;
    }
    .miniRow{
      display:grid;
      grid-template-columns: 1fr;
      gap: 6px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .miniTop{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 12px;
      font-weight: 900;
    }
    .miniTop .lbl{
      color: rgba(234,242,255,.92);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 70%;
    }
    .miniTop .val{
      color: rgba(234,242,255,.72);
      font-weight: 950;
      white-space: nowrap;
    }
    .miniTop .pct{
      font-weight: 950;
      color: rgba(234,242,255,.86);
      margin-left: 10px;
    }
    .miniTrack{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
    }
    .miniFill{
      height:100%;
      width:0%;
      border-radius:999px;
      transition: width .35s ease;
    }
    .miniHint{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(234,242,255,.60);
      font-weight: 750;
    }

    /* palettes par thème */
    .t-nuit .badgeDot{ background: var(--blueA); }
    .t-catalan .badgeDot{ background: var(--yellowA); }
    .t-wheel .badgeDot{ background: var(--greenA); }
    .t-hibair .badgeDot{ background: var(--violetA); }

    .t-nuit .miniFill{ background: linear-gradient(90deg, var(--blueA), var(--blueB)); }
    .t-catalan .miniFill{ background: linear-gradient(90deg, var(--yellowA), var(--yellowB)); }
    .t-wheel .miniFill{ background: linear-gradient(90deg, var(--greenA), var(--greenB)); }
    .t-hibair .miniFill{ background: linear-gradient(90deg, var(--violetA), var(--violetB)); }

    .pillKpi{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .pillKpi .l{ color: rgba(234,242,255,.72); font-weight: 850; }
    .pillKpi .r{ font-weight: 950; letter-spacing:.3px; }

    .gridBottom{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .gridBottom{ grid-template-columns: 1fr; }
    }

    /* tables existantes (on ne touche pas style.css, juste confort) */
    .tableWrap{ margin-top: 8px; }
  </style>
</head>

<body>
  <div class="bg"></div>

  <div class="top">
    <div class="brand">
      <img class="logo" src="./icon-192.png" alt="Logo" />
      <div>
        <div class="h1">Stats</div>
        <div class="sub">Dashboard marketing • suivi des clics</div>
      </div>
    </div>

    <div class="pills">
      <div class="pill"><span class="dot"></span>Cloudflare Workers</div>
      <div class="pill">D1 • <span id="dbName">stats_db</span></div>
      <div class="pill">API • <span id="apiHost">stats.aperos.net</span></div>
    </div>

    <div class="actions">
      <button class="btn" id="btnRefresh">Actualiser</button>
      <button class="btn ghost" id="btnCopyLinks">Copier mes liens</button>
      <button class="btn ghost" id="btnInstall" hidden>Ajouter à l’écran d’accueil</button>
    </div>

    <div class="statusRow">
      <div id="status" class="status warn">—</div>
      <div class="mini">
        <span>Auto</span>
        <label class="switch" title="Auto-refresh 30s">
          <input type="checkbox" id="autoToggle" />
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card hero">
      <div class="heroTitle">APERO DE NUIT 66</div>
      <div class="heroText">
        <b>stat.aperos.net</b> • stats globales + détails (events)
        <div class="mutedNote" style="margin-top:8px">
          Objectif : comparer Apéro de Nuit vs Apéro Catalan + suivre les actions clés (appel, commande, âge, roue, hibair).
        </div>
      </div>
    </div>

    <!-- KPIs globaux (inchangés + events) -->
    <div class="grid">
      <div class="card kpi">
        <div class="kpiLabel">Clics total</div>
        <div class="kpiValue" id="kpiTotal">—</div>
        <div class="kpiHint">Table clicks (campagnes)</div>
      </div>
      <div class="card kpi">
        <div class="kpiLabel">Aujourd’hui</div>
        <div class="kpiValue" id="kpiToday">—</div>
        <div class="kpiHint">Date locale</div>
      </div>
      <div class="card kpi">
        <div class="kpiLabel">Campagnes suivies</div>
        <div class="kpiValue" id="kpiCampaigns">—</div>
        <div class="kpiHint">apero • catalan • chance • jeux</div>
      </div>

      <div class="card kpi">
        <div class="kpiLabel">Events total</div>
        <div class="kpiValue" id="kpiEventsTotal">—</div>
        <div class="kpiHint">Actions & canaux fins</div>
      </div>
      <div class="card kpi">
        <div class="kpiLabel">Events aujourd’hui</div>
        <div class="kpiValue" id="kpiEventsToday">—</div>
        <div class="kpiHint">Aujourd’hui (local)</div>
      </div>
    </div>

    <!-- 1) Comparatif global Nuit vs Catalan -->
    <div class="sectionTitle">
      <div class="t">Comparatif</div>
      <div class="k">Apéro de Nuit vs Apéro Catalan</div>
    </div>

    <div class="block">
      <div class="blockHead">
        <div>
          <div class="blockTitle"><span class="badgeDot" style="background:rgba(255,255,255,.35)"></span> Clics total : Nuit vs Catalan</div>
          <div class="blockSub">Basé sur tes events (brand = apero_nuit / apero_catalan)</div>
        </div>
        <span class="chip">events.byBrand</span>
      </div>
      <div class="blockBody">
        <div class="twoCols">
          <div class="pillKpi">
            <div class="l">Apéro de Nuit 66</div>
            <div class="r" id="kpiBrandNuit">—</div>
          </div>
          <div class="pillKpi">
            <div class="l">Apéro Catalan</div>
            <div class="r" id="kpiBrandCatalan">—</div>
          </div>
        </div>

        <div class="twoCols" style="margin-top:14px;">
          <div class="miniViz t-nuit" id="vizBrandNuit"></div>
          <div class="miniViz t-catalan" id="vizBrandCatalan"></div>
        </div>
        <div class="miniHint" style="margin-top:8px">
          Astuce : si Nuit est devant, pousse SMS/QR du côté qui “convertit”. Si Catalan monte, mets-le plus visible sur tes supports.
        </div>
      </div>
    </div>

    <!-- 2) Encart Apéro de Nuit (bleu) -->
    <div class="sectionTitle">
      <div class="t">Apéro de Nuit 66</div>
      <div class="k">Bleu • canaux + actions + âge</div>
    </div>

    <div class="block t-nuit">
      <div class="blockHead">
        <div>
          <div class="blockTitle"><span class="badgeDot"></span> Apéro de Nuit 66</div>
          <div class="blockSub">site / facebook / sms / qr / app + appeler + commander + âge</div>
        </div>
        <span class="chip">events.byEvent</span>
      </div>
      <div class="blockBody">
        <div class="twoCols">
          <div>
            <div class="pillKpi"><div class="l">Total Nuit (events)</div><div class="r" id="kpiNuitTotal">—</div></div>
            <div class="miniViz t-nuit" id="vizNuitChannels"></div>
          </div>

          <div>
            <div class="pillKpi"><div class="l">Actions Nuit</div><div class="r" id="kpiNuitActions">—</div></div>
            <div class="miniViz t-nuit" id="vizNuitActions"></div>
          </div>
        </div>

        <!-- Âge Oui / Non à la fin de l'encart -->
        <div style="margin-top:14px;">
          <div class="pillKpi"><div class="l">Âge (Nuit) — Oui / Non</div><div class="r" id="kpiNuitAge">—</div></div>
          <div class="miniViz t-nuit" id="vizNuitAge"></div>
        </div>
      </div>
    </div>

    <!-- 3) Encart Apéro Catalan (jaune) -->
    <div class="sectionTitle">
      <div class="t">Apéro Catalan</div>
      <div class="k">Jaune • actions + âge</div>
    </div>

    <div class="block t-catalan">
      <div class="blockHead">
        <div>
          <div class="blockTitle"><span class="badgeDot"></span> Apéro Catalan</div>
          <div class="blockSub">appeler + âge (accept/refuse) + (si tu ajoutes des canaux plus tard, ça suivra)</div>
        </div>
        <span class="chip">events.byEvent</span>
      </div>
      <div class="blockBody">
        <div class="twoCols">
          <div>
            <div class="pillKpi"><div class="l">Total Catalan (events)</div><div class="r" id="kpiCatalanTotal">—</div></div>
            <div class="miniViz t-catalan" id="vizCatalanActions"></div>
          </div>

          <div>
            <div class="pillKpi"><div class="l">Âge (Catalan) — Oui / Non</div><div class="r" id="kpiCatalanAge">—</div></div>
            <div class="miniViz t-catalan" id="vizCatalanAge"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 4) Roue de la fortune -->
    <div class="sectionTitle">
      <div class="t">Roue de la fortune</div>
      <div class="k">Vert • performance SMS</div>
    </div>

    <div class="block t-wheel">
      <div class="blockHead">
        <div>
          <div class="blockTitle"><span class="badgeDot"></span> Roue de la fortune</div>
          <div class="blockSub">Suivi : wheel.sms.click</div>
        </div>
        <span class="chip">wheel</span>
      </div>
      <div class="blockBody">
        <div class="pillKpi"><div class="l">Total roue</div><div class="r" id="kpiWheelTotal">—</div></div>
        <div class="miniViz t-wheel" id="vizWheel"></div>
      </div>
    </div>

    <!-- 5) Hibair Drink -->
    <div class="sectionTitle">
      <div class="t">Hibair Drink</div>
      <div class="k">Violet • canaux</div>
    </div>

    <div class="block t-hibair">
      <div class="blockHead">
        <div>
          <div class="blockTitle"><span class="badgeDot"></span> Hibair Drink</div>
          <div class="blockSub">facebook / sms / qr / application</div>
        </div>
        <span class="chip">hibair</span>
      </div>
      <div class="blockBody">
        <div class="pillKpi"><div class="l">Total Hibair</div><div class="r" id="kpiHibairTotal">—</div></div>
        <div class="miniViz t-hibair" id="vizHibair"></div>
      </div>
    </div>

    <!-- 6) Bas : le reste (campagnes / sources / devices / os / browser / hourly / last) -->
    <div class="sectionTitle">
      <div class="t">Détails</div>
      <div class="k">Tech & lecture fine</div>
    </div>

    <div class="grid2">
      <!-- Campagnes (table clicks classique) -->
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Campagnes (table clicks)</div>
            <div class="sub">apero / catalan / chance / jeux</div>
          </div>
          <span class="chip">clicks.byCampaign</span>
        </div>

        <div class="campaignCards">
          <div class="campaignCard">
            <div class="campTop">
              <div class="campName">Apéro</div>
              <span class="campPill">apero</span>
            </div>
            <div class="campValue" id="cApero">—</div>
            <div class="campExact">/go/apero?src=…</div>
          </div>

          <div class="campaignCard">
            <div class="campTop">
              <div class="campName">Catalan</div>
              <span class="campPill">catalan</span>
            </div>
            <div class="campValue" id="cCatalan">—</div>
            <div class="campExact">/go/catalan?src=…</div>
          </div>

          <div class="campaignCard">
            <div class="campTop">
              <div class="campName">Chance</div>
              <span class="campPill">chance</span>
            </div>
            <div class="campValue" id="cChance">—</div>
            <div class="campExact">/go/chance?src=…</div>
          </div>

          <div class="campaignCard">
            <div class="campTop">
              <div class="campName">Jeux</div>
              <span class="campPill">jeux</span>
            </div>
            <div class="campValue" id="cJeux">—</div>
            <div class="campExact">/go/jeux?src=…</div>
          </div>
        </div>

        <div class="tableWrap">
          <table class="table">
            <thead>
              <tr>
                <th>Campagne</th>
                <th class="right">Clics</th>
                <th class="hideSm">Tracking</th>
                <th class="hideSm">Destination</th>
              </tr>
            </thead>
            <tbody id="tbodyCampaign"></tbody>
          </table>
        </div>
        <div class="hint">Tip : src propre (facebook / sms / qr / direct)</div>
      </div>

      <!-- Source -->
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Origines (source)</div>
            <div class="sub">sms / facebook / qr / direct…</div>
          </div>
          <span class="chip">bySource</span>
        </div>
        <div class="tableWrap">
          <table class="table small">
            <thead><tr><th>Source</th><th class="right">Clics</th></tr></thead>
            <tbody id="tbodySource"></tbody>
          </table>
        </div>
        <div id="vizSource" class="miniViz"></div>
      </div>

      <!-- Devices / OS / Browser (sans Pays) -->
      <div class="gridBottom">
        <div class="card">
          <div class="cardHead">
            <div>
              <div class="cardTitle">Appareils</div>
              <div class="sub">mobile / desktop</div>
            </div>
            <span class="chip">Device</span>
          </div>
          <div class="tableWrap">
            <table class="table small">
              <thead><tr><th>Appareil</th><th class="right">Clics</th></tr></thead>
              <tbody id="tbodyDevice"></tbody>
            </table>
          </div>
          <div id="vizDevice" class="miniViz"></div>
        </div>

        <div class="card">
          <div class="cardHead">
            <div>
              <div class="cardTitle">Systèmes</div>
              <div class="sub">Android / iOS / Windows / macOS…</div>
            </div>
            <span class="chip">OS</span>
          </div>
          <div class="tableWrap">
            <table class="table small">
              <thead><tr><th>OS</th><th class="right">Clics</th></tr></thead>
              <tbody id="tbodyOS"></tbody>
            </table>
          </div>
          <div id="vizOS" class="miniViz"></div>
        </div>

        <div class="card">
          <div class="cardHead">
            <div>
              <div class="cardTitle">Navigateurs</div>
              <div class="sub">Chrome / Safari / Edge…</div>
            </div>
            <span class="chip">Browser</span>
          </div>
          <div class="tableWrap">
            <table class="table small">
              <thead><tr><th>Navigateur</th><th class="right">Clics</th></tr></thead>
              <tbody id="tbodyBrowser"></tbody>
            </table>
          </div>
          <div id="vizBrowser" class="miniViz"></div>
        </div>

        <div class="card">
          <div class="cardHead">
            <div>
              <div class="cardTitle">Clics par heure (aujourd’hui)</div>
              <div class="sub">si hourly est renvoyé</div>
            </div>
            <span class="chip">Heure locale</span>
          </div>
          <div class="tableWrap">
            <table class="table small">
              <thead><tr><th>Heure</th><th class="right">Clics</th></tr></thead>
              <tbody id="tbodyHourly"></tbody>
            </table>
          </div>
          <div id="vizHourly" class="miniViz"></div>
        </div>
      </div>

      <!-- Derniers clics -->
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Derniers clics</div>
            <div class="sub">les 50 derniers (si last est renvoyé)</div>
          </div>
          <span class="chip">last</span>
        </div>
        <div class="tableWrap">
          <table class="table small">
            <thead>
              <tr>
                <th>Date</th>
                <th>Campagne</th>
                <th>Source</th>
                <th>Pays</th>
                <th class="hideSm">Device</th>
                <th class="hideSm">OS</th>
                <th class="hideSm">Browser</th>
              </tr>
            </thead>
            <tbody id="tbodyLast"></tbody>
          </table>
        </div>
      </div>

      <div class="foot">
        <span id="buildInfo">PWA prête</span>
        <span class="sep">•</span>
        <button class="linkBtn" id="btnHardReload">Forcer MAJ</button>
        <span class="sep">•</span>
        <a href="https://stats.aperos.net/api/health" target="_blank" rel="noopener">Health</a>
        <span class="sep">•</span>
        <a href="https://stats.aperos.net/api/stats" target="_blank" rel="noopener">Stats</a>
      </div>
    </div>

    <!-- Tables events invisibles (source de vérité) : app.js les remplit, et nos graphes les lisent -->
    <div style="display:none">
      <table><tbody id="tbodyEvent"></tbody></table>
      <table><tbody id="tbodyBrand"></tbody></table>
      <table><tbody id="tbodyChannel"></tbody></table>
      <table><tbody id="tbodyAction"></tbody></table>
      <table><tbody id="tbodyCountry"></tbody></table>
    </div>
  </div>

  <script src="./app.js"></script>

  <!-- ✅ Layout analytics : lit les tbody remplis par app.js et génère les mini-graphes par section -->
  <script>
    (function(){
      const $ = (id) => document.getElementById(id);

      function toInt(txt){
        if(!txt) return 0;
        const n = String(txt).replace(/[^\d]/g,'');
        return n ? parseInt(n,10) : 0;
      }
      function fmt(n){
        const v = Number(n);
        if(!Number.isFinite(v)) return "—";
        return new Intl.NumberFormat("fr-FR").format(v);
      }

      function parseTableBody(tbodyId){
        const tb = $(tbodyId);
        if(!tb) return [];
        const rows = Array.from(tb.querySelectorAll("tr"));
        const out = [];
        for(const tr of rows){
          const tds = tr.querySelectorAll("td,th");
          if(!tds || tds.length < 2) continue;
          const label = (tds[0].textContent || "").trim();
          const value = toInt((tds[1].textContent || "").trim());
          if(label) out.push({label, value});
        }
        return out;
      }

      function renderMiniViz(containerId, items, themeClass, opts={}){
        const container = $(containerId);
        if(!container) return;

        container.className = "miniViz " + (themeClass || "");

        if(!items || !items.length){
          container.innerHTML = `<div class="miniHint">— Pas de données pour l’instant</div>`;
          return;
        }

        const maxItems = opts.maxItems ?? 6;
        const sorted = items.slice().sort((a,b)=>b.value-a.value);
        const total = sorted.reduce((s,x)=>s+x.value,0) || 0;

        const top = sorted.slice(0, maxItems);
        const rest = sorted.slice(maxItems);
        const otherSum = rest.reduce((s,x)=>s+x.value,0);
        if(otherSum > 0) top.push({label:"Autres", value: otherSum});

        const maxV = Math.max(...top.map(x=>x.value), 1);

        container.innerHTML =
          top.map(x=>{
            const pct = total ? (x.value/total*100) : 0;
            const w = maxV ? (x.value/maxV*100) : 0;
            return `
              <div class="miniRow">
                <div class="miniTop">
                  <div class="lbl" title="${x.label}">${x.label}</div>
                  <div class="val">${fmt(x.value)}<span class="pct"> • ${pct.toFixed(0)}%</span></div>
                </div>
                <div class="miniTrack"><div class="miniFill" style="width:${w.toFixed(2)}%"></div></div>
              </div>
            `;
          }).join("")
          + (opts.hint ? `<div class="miniHint">${opts.hint}</div>` : "");
      }

      function filterStarts(items, prefix){
        return (items||[]).filter(x => String(x.label||"").startsWith(prefix));
      }

      function pick(items, contains){
        return (items||[]).filter(x => String(x.label||"").includes(contains));
      }

      function sum(items){ return (items||[]).reduce((s,x)=>s+(x.value||0),0); }

      function updateDashboard(){
        // source/device/os/browser/hourly (tables classiques)
        renderMiniViz("vizSource",  parseTableBody("tbodySource"),  "", {hint:"Répartition des clics par source"});
        renderMiniViz("vizDevice",  parseTableBody("tbodyDevice"),  "", {hint:"Mobile vs Desktop"});
        renderMiniViz("vizOS",      parseTableBody("tbodyOS"),      "", {hint:"Android / iOS / Windows / macOS…"});
        renderMiniViz("vizBrowser", parseTableBody("tbodyBrowser"), "", {hint:"Chrome / Safari / Edge…"});
        renderMiniViz("vizHourly",  parseTableBody("tbodyHourly"),  "", {hint:"Distribution aujourd’hui par heure"});

        // events.byBrand (comparatif)
        const brands = parseTableBody("tbodyBrand");
        const nuitRow = brands.find(x => x.label === "apero_nuit");
        const catalanRow = brands.find(x => x.label === "apero_catalan");

        const nuitTotal = nuitRow ? nuitRow.value : 0;
        const catalanTotal = catalanRow ? catalanRow.value : 0;

        if($("kpiBrandNuit")) $("kpiBrandNuit").textContent = fmt(nuitTotal);
        if($("kpiBrandCatalan")) $("kpiBrandCatalan").textContent = fmt(catalanTotal);

        // petites barres comparatives (1 ligne chacune)
        renderMiniViz("vizBrandNuit", [{label:"Apéro de Nuit 66", value:nuitTotal}], "t-nuit", {maxItems: 6, hint:"Total events Nuit"});
        renderMiniViz("vizBrandCatalan", [{label:"Apéro Catalan", value:catalanTotal}], "t-catalan", {maxItems: 6, hint:"Total events Catalan"});

        // events.byEvent (labels humains)
        const ev = parseTableBody("tbodyEvent");

        // Apéro Nuit (canaux)
        const nuitEvents = filterStarts(ev, "Apéro de Nuit 66 — ");
        const nuitChannels = pick(nuitEvents, "— Site")
          .concat(pick(nuitEvents, "— Facebook"))
          .concat(pick(nuitEvents, "— SMS"))
          .concat(pick(nuitEvents, "— QR"))
          .concat(pick(nuitEvents, "— Application"));

        const nuitActions = []
          .concat(pick(nuitEvents, "— Bouton appeler"))
          .concat(pick(nuitEvents, "— Commander"));

        const nuitAge = []
          .concat(pick(nuitEvents, "— Accepter l’âge"))
          .concat(pick(nuitEvents, "— Refuser l’âge"));

        if($("kpiNuitTotal")) $("kpiNuitTotal").textContent = fmt(sum(nuitEvents));
        if($("kpiNuitActions")) $("kpiNuitActions").textContent = fmt(sum(nuitActions));
        if($("kpiNuitAge")) $("kpiNuitAge").textContent = fmt(sum(nuitAge));

        renderMiniViz("vizNuitChannels", nuitChannels, "t-nuit", {hint:"Canaux Nuit (site/facebook/sms/qr/app)"});
        renderMiniViz("vizNuitActions", nuitActions, "t-nuit", {hint:"Actions Nuit (appeler/commander)"});
        renderMiniViz("vizNuitAge", nuitAge, "t-nuit", {hint:"Âge Nuit (oui/non)"});

        // Apéro Catalan
        const catEvents = filterStarts(ev, "Apéro Catalan — ");
        const catActions = []
          .concat(pick(catEvents, "— Bouton appeler"));

        const catAge = []
          .concat(pick(catEvents, "— Accepter l’âge"))
          .concat(pick(catEvents, "— Refuser l’âge"));

        if($("kpiCatalanTotal")) $("kpiCatalanTotal").textContent = fmt(sum(catEvents));
        if($("kpiCatalanAge")) $("kpiCatalanAge").textContent = fmt(sum(catAge));

        renderMiniViz("vizCatalanActions", catActions.concat(catAge), "t-catalan", {hint:"Catalan (appeler + âge)"});
        renderMiniViz("vizCatalanAge", catAge, "t-catalan", {hint:"Âge Catalan (oui/non)"});

        // Wheel
        const wheel = pick(ev, "Roue de la fortune — ");
        if($("kpiWheelTotal")) $("kpiWheelTotal").textContent = fmt(sum(wheel));
        renderMiniViz("vizWheel", wheel, "t-wheel", {hint:"Roue de la fortune (SMS)"});

        // Hibair
        const hibair = filterStarts(ev, "Hibair Drink — ");
        if($("kpiHibairTotal")) $("kpiHibairTotal").textContent = fmt(sum(hibair));
        renderMiniViz("vizHibair", hibair, "t-hibair", {hint:"Hibair (facebook/sms/qr/app)"});
      }

      // Observe mutations (app.js remplit les tbody)
      function boot(){
        updateDashboard();
        const ids = [
          "tbodySource","tbodyDevice","tbodyOS","tbodyBrowser","tbodyHourly",
          "tbodyBrand","tbodyEvent"
        ];

        const obs = new MutationObserver(() => updateDashboard());
        ids.forEach(id=>{
          const el = $(id);
          if(el) obs.observe(el, {childList:true, subtree:true, characterData:true});
        });

        const btn = $("btnRefresh");
        if(btn){
          btn.addEventListener("click", () => {
            setTimeout(updateDashboard, 600);
          });
        }
      }

      if(document.readyState === "loading"){
        document.addEventListener("DOMContentLoaded", boot);
      }else{
        boot();
      }
    })();
  </script>
</body>
</html>
